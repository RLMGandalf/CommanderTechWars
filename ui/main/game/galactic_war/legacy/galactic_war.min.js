(function(){"use strict";window.Omega={Models:{Cards:{}},Collections:{Collection:Backbone.Collection},Geom:{},Views:{},Utils:{},Templates:window.JST||[]};var e=new Jaff.Module;Omega.define=function(t){return e.define(t)};Omega.require=function(t){return e.require(t)}})();Omega.define(function(){"use strict";var e=Omega.require("Omega.config"),t=Omega.require("Omega.Models.GameModel"),a=Omega.require("Omega.Collections.GameCollection"),i=Omega.require("Omega.Models.GalaxyModel"),s=Omega.require("Omega.Models.DeckModel"),n=Omega.require("Omega.Views.NewGameView"),o=Omega.require("Omega.Views.SavedGamesView"),r=Omega.require("Omega.Views.GameView"),l=Omega.require("Omega.Views.StarmapView"),d=Omega.require("Omega.Views.CurrentTargetView"),c=Omega.require("Omega.Views.PlayingModal"),h=Omega.require("Omega.Models.SystemModel");Omega.Application=function(){this.initialize()};Omega.Application.prototype={initialize:function(){this.jsonRequests=[];this.jsonRequests.push($.getJSON(e.pathToJson+"/names.json",function(t){e.systemNames=_.unique(t)}));e.planetTemplates=[];e.planetFiles.forEach(function(t){this.jsonRequests.push($.getJSON(e.pathToJson+"/"+t,function(t){e.planetTemplates.push(t)}))},this)},run:function(){var e=window.location.hash.substr(2)||localStorage.galactic_war_view;localStorage.galactic_war_view=e=="exit"?"":e;this.history=["exit"];$.when.apply($,this.jsonRequests).done($.proxy(this.loadView,this))},loadView:function(){switch(localStorage.galactic_war_view){case"test":this.playPA();break;case"clear":this.clearLocalStorage();alert("All clear!");break;case"newGame":this.startNewGame();break;case"loadGame":this.loadSavedGame();break;case"exit":window.location.href=e.pathToExit;break;case"lastGame":this.lastGame();break;case"results":this.battleResults();break;default:this.loadSavedGame();break}},clearLocalStorage:function(){localStorage.removeItem("galactic_war_view");_.each(["gwdb_game","gwdb_galaxy","gwdb_deck"],function(e){var t=new Backbone.LocalStorage(e);t._clear()})},battleResults:function(){var e=JSON.parse('[{"faction":0,"commander":{"lastPosition":"system-0","newPosition":"system-3"},"systemsOwned":["System 0","System 1","System 10","System 11","System 12","System 3","System 4","System 7","System 8","System 9"],"systemsLost":[],"systemsWon":["System 1","System 10","System 11","System 3","System 7"]},{"faction":1,"commander":{"lastPosition":"system-10"},"systemsOwned":[],"systemsLost":["System 10","System 11","System 3","System 5"],"systemsWon":[]},{"faction":2,"commander":{"lastPosition":"system-16","newPosition":"system-16"},"systemsOwned":["System 14","System 16","System 19","System 5","System 6"],"systemsLost":["System 17"],"systemsWon":["System 14","System 19","System 5","System 6"]},{"faction":3,"commander":{"lastPosition":"system-18","newPosition":"system-15"},"systemsOwned":["System 13","System 15","System 17","System 18"],"systemsLost":[],"systemsWon":["System 13","System 15","System 17"]}]'),a=JSON.parse('[{ "title" : "Defensive Campaign","type" : "galaxy"}, { "title" : "Attack Campaign","type" : "galaxy"}, { "title" : "Installation Base","type" : "system"}, { "title" : "Covert Operation","type" : "system"}, { "title" : "Type I","type" : "planet"}, { "title" : "Type II","type" : "planet"}]');if(!this.game){var i=this.getLastGameId();this.game=t.findOrCreate(i);this.game.fetch()}this.game.set("isPlayCards",false);this.game.set("factionResults",e);this.game.set("awardedCards",a);var s=this.game.fetchRelated("galaxy"),n=this.game.fetchRelated("deck");$.when(s,n).then($.proxy(function(){this.playGame()},this))},startNewGame:function(){this.clearScreen();this.game=new t;this.view=new n({el:".container",model:this.game});this.view.on("cancel",this.navBack,this);this.view.on("create",this.buildNewGame,this);this.view.render()},buildNewGame:function(){this.buildNewGalaxy();this.dealNewDeck();this.game.save();this.playGame()},buildNewGalaxy:function(){var e=new i({seed:this.game.get("seed"),galaxySize:this.game.get("galaxySize"),playerFaction:this.game.get("factionColor")});e.build();e.save();this.game.set("galaxy",e)},dealNewDeck:function(){var e=new s({seed:this.game.get("seed")});e.build();e.save();this.game.set("deck",e)},loadSavedGame:function(){this.savedGames=new a;this.savedGames.fetch();this.clearScreen();this.view=new o({el:".container",collection:this.savedGames});this.view.render();this.view.on("back",this.navBack,this);this.view.on("delete",this.deleteGame,this);this.view.on("load",this.loadGame,this);this.view.on("new",function(){this.history.push("loadGame");this.startNewGame()},this)},deleteGame:function(e){var t=this.savedGames.get(e),a,i;this.savedGames.remove(t);a=t.fetchRelated("galaxy");i=t.fetchRelated("deck");$.when(a,i).then(function(){t.get("galaxy").destroy();t.get("deck").destroy();t.destroy()})},lastGame:function(e){var e=this.getLastGameId();this.loadGame(e)},getLastGameId:function(){this.savedGames=new a;this.savedGames.fetch();return this.savedGames.pluck("id").pop()},loadGame:function(e){this.game=this.savedGames.get(e);var t=this.game.fetchRelated("galaxy"),a=this.game.fetchRelated("deck");$.when(t,a).then($.proxy(function(){this.playGame()},this))},playGame:function(){this.clearScreen();this.view=new r({el:".container",model:this.game});this.view.render();this.view.on("quit",this.navBack,this);this.game.on("playPA",this.playPA,this)},playPA:function(){this.clearScreen();if(this.game){this.results={gameId:this.game.id};this.game.save();this.game.get("galaxy").save();this.game.get("deck").save()}else{var e=this.getLastGameId();this.results={gameId:e}}this.game=null;this.view=new c({el:".container"});this.view.render();this.view.on("done",this.returnFromPA,this)},returnFromPA:function(e){this.results.playerWon=e;Backbone.Relational.store.reset();this.game=new t({id:this.results.gameId});this.game.fetch();var a=this.game.fetchRelated("galaxy"),i=this.game.fetchRelated("deck");$.when(a,i).then($.proxy(function(){this.game.resolveRound(e);this.playGame()},this))},navBack:function(){localStorage.galactic_war_view=this.history.pop();this.loadView()},clearScreen:function(){if(this.view)this.view.remove();this.view=null;$("#all").html('<div class="container"></div>')}}});Omega.define(function(){"use strict";var e=Omega.require("Omega.Collections.Collection"),t=Omega.require("Omega.Models.CardModel");Omega.Collections.CardCollection=e.extend({model:t})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Collections.Collection"),t=Omega.require("Omega.Models.CardModel");Omega.Collections.DeckCollection=e.extend({model:t})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Collections.Collection"),t=Omega.require("Omega.Models.GameModel");Omega.Collections.GameCollection=e.extend({localStorage:new Backbone.LocalStorage("gwdb_game"),model:t,comparator:"lastBattle"})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Collections.Collection"),t=Omega.require("Omega.Models.PlanetModel");Omega.Collections.PlanetCollection=e.extend({model:t})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Collections.Collection"),t=Omega.require("Omega.Models.SystemModel");Omega.Collections.SystemCollection=e.extend({model:t})});Omega.define(function(){"use strict";Omega.config=Omega.config||{};Omega.config.cards=[{model:"PlanetCardModel",type:"planet",title:"Type I",description:"Type I planet card.  No effect.",duration:1,weight:5},{model:"PlanetCardModel",type:"planet",title:"Type II",description:"Type II planet card.  No effect.",duration:1,weight:5},{model:"PlanetCardModel",type:"planet",title:"Type III",description:"Type III planet card.  No effect.",duration:1,weight:2},{model:"DieRollCardModel",type:"system",title:"Installation: Ops Relay",description:"All auto-resolved battles fought in any adjacent system receives a +10% bonus.",attackBonus:10,range:"adjacent",duration:1,weight:2},{model:"DieRollCardModel",type:"system",title:"Installation: Command Station",description:"All auto-resolved battles fought in any adjacent system receives a +25% bonus.",attackBonus:25,range:"adjacent",duration:1,weight:1},{model:"DieRollCardModel",type:"system",title:"Simulation: Attack Plan",description:"+10% bonus to conquer an auto-resolved attack in system this turn",attackBonus:10,range:"this-sytem",duration:1,weight:5},{model:"DieRollCardModel",type:"system",title:"Simulation: Entrench",description:"+10% bonus to defend against an auto-resolved attack in system for 1 turn",defenseBonus:10,range:"this-sytem",duration:1,weight:5},{model:"DieRollCardModel",type:"system",title:"Simulation: Attack Plan (advanced)",description:"+25% bonus to conquer an auto-resolved attack in system this turn",attackBonus:25,range:"this-sytem",duration:1,weight:2},{model:"DieRollCardModel",type:"system",title:"Simulation: Entrench (advanced)",description:"+25% bonus to defend against an auto-resolved attack in system for 1 turn",defenseBonus:25,range:"this-sytem",duration:1,weight:2},{model:"DieRollCardModel",type:"system",title:"Sabotage: Covert Operation",description:"Automatically win auto-resolved battle in system this turn.",attackBonus:Infinity,range:"this-sytem",duration:1,weight:1},{model:"CardDealCardModel",type:"system",title:"Installation: R&D Station",description:"Increase chance of drawing rare cards.",effectType:"rare",duration:1,weight:2},{model:"CardDealCardModel",type:"system",title:"Installation: Simulation Farm",description:"Greatly increase chance of drawing rare cards.",effectType:"rare-plus",duration:1,weight:1},{model:"DieRollCardModel",type:"galaxy",title:"Simulation: Attack Campaign",description:"All auto-resolved attacks gain a +10% bonus",attackBonus:10,range:"commander-adjacent",weight:5},{model:"DieRollCardModel",type:"galaxy",title:"Simulation: Defensive Campaign",description:"All auto-resolved defensive rolls gain a +10% bonus",defenseBonus:10,range:"commander-adjacent",weight:5},{model:"DieRollCardModel",type:"galaxy",title:"Simulation: Attack Campaign (advanced)",description:"All auto-resolved attacks gain a +25% bonus",attackBonus:25,range:"commander-adjacent",weight:5},{model:"DieRollCardModel",type:"galaxy",title:"Simulation: Defensive Campaign (advanced)",description:"All auto-resolved defensive rolls gain a +25% bonus",defenseBonus:25,range:"commander-adjacent",weight:5},{model:"DieRollCardModel",type:"galaxy",title:"Simulation: Galactic Domination",description:"All auto-resolved combats gain a +20% bonus this turn",attackBonus:20,defenseBonus:20,range:"commander-adjacent",weight:2},{model:"DieRollCardModel",type:"galaxy",title:"Simulation: Galactic Supremacy",description:"All auto-resolved combats are successful this turn",attackBonus:Infinity,defenseBonus:Infinity,range:"commander-adjacent",weight:1},{model:"CardDealCardModel",type:"galaxy",title:"Research: Technology",description:"Increase the chance of drawing rare cards for 2 turns",effectType:"rare",duration:2,weight:2},{model:"CardDealCardModel",type:"galaxy",title:"Research: Technology (advanced)",description:"greatly Increase the chance of drawing rare cards for 2 turns",effectType:"rare-plus",duration:2,weight:1},{model:"CardDealCardModel",type:"galaxy",title:"Research: Galactic Database",description:"Increase chance of drawing galaxy cards for 3 turns",effectType:"galaxy",duration:3,weight:4},{model:"CardDealCardModel",type:"galaxy",title:"Research: System Scan",description:"Increase chance of drawing system cards for 3 turns",effectType:"system",duration:1,weight:4},{model:"CardDealCardModel",type:"galaxy",title:"Research: Terrestrial Upgrade",description:"Increase chance of drawing planetary cards for 3 turns",effectType:"planet",duration:3,weight:4},{model:"CardDealCardModel",type:"galaxy",title:"Research: Galactic Database (advanced)",description:"Drastically Increase chance of drawing galaxy cards for 1 turn",effectType:"galaxy-plus",duration:1,weight:1},{model:"CardDealCardModel",type:"galaxy",title:"Research: System Scan (advanced)",description:"Drastically Increase chance of drawing system cards for 1 turn",effectType:"system-plus",duration:1,weight:1},{model:"CardDealCardModel",type:"galaxy",title:"Research: Terrestrial Upgrade (advanced)",description:"Drastically Increase chance of drawing planetary cards for 1 turn",effectType:"planet-plus",duration:1,weight:1}]});Omega.define(function(){"use strict";Omega.config=_.extend(Omega.config||{},{pathToExit:"../start/start.html",pathToJson:"media/json",planetFiles:["system-epic-1.json","system-epic-1.json","system-medium-1.json","system-medium-2.json","system-small-1.json","system-small-2.json","system-small-3.json","system-small-4.json","system-standard-1.json","system-standard-2.json"]})});Omega.define(function(){"use strict";var e=Omega.require("Omega.localization"),t=window.location.host==="localhost:3000",a=window.navigator.language||window.navigator.browserLanguage||"",i=a.split("-");a=i.length>0?i[0].toLowerCase():"";Omega.environment={isDevelopment:t,imagePath:t?"media/images/":"media/images/",language:a,localizedStrings:e[a]||e.en}});Omega.define(function(){"use strict";Omega.localization={en:{galactic_war:"Galactic War",planetary_annihilation:"Planetary Annihilation",defaultGameName:"New Game",cancel:"Cancel",create:"Create"}}});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.Model"),t=["PlanetCardModel","DieRollCardModel","CardDealCardModel"],a=t.reduce(function(e,t){e[t]="Omega.Models.Cards."+t;return e},{});Omega.Models.CardModel=e.extend({subModelTypes:a,subModelTypeAttribute:"cardEffectType",defaults:{title:null,type:null,applyPhase:null,effectTarget:null,description:"",lastLocation:null,location:null,position:null,systemId:null,duration:1,turnsRemaining:1},isInPlay:function(){return this.get("systemId")},canApply:function(e,t){return this.get("applyPhase")==e&&this.get("effectTarget")==t},applyEffect:function(){},undoEffect:function(){}});Omega.Models.CardModel.subModelNames=t;Omega.Models.CardModel.subModelTypes=a});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.Model"),t=Omega.require("Omega.Models.CardModel"),a=Omega.require("Omega.Collections.CardCollection"),i=Omega.require("Omega.Utils.CardDealer");Omega.Models.DeckModel=e.extend({localStorage:new Backbone.LocalStorage("gwdb_deck"),relations:[{type:Backbone.HasMany,key:"deck",relatedModel:"Omega.Models.CardModel",collectionType:"Omega.Collections.CardCollection",reverseRelation:{key:"deckId",includeInJSON:true}}],defaults:{seed:0,playArea:"",systemId:null,deck:null,uniqueCardId:0,voidCards:null},setPlayArea:function(e){this.set("playArea",e);this.trigger("changePlayArea")},selectSystem:function(e){this.set("systemId",e);if(e=="galaxy"||e=="planet"){this.set("playArea",e)}else{this.set("playArea","system")}},build:function(){var e=new a,t=new i({seed:this.get("seed")});this.buildDeck("galaxy",e,t);this.buildDeck("system",e,t);this.buildDeck("planet",e,t);this.set("deck",e)},buildDeck:function(e,t,a){_.range(5).forEach(function(i){var s=a.getRandomCard(e);s.set("id",this.getUniqueCardId());s.set("lastLocation",e+"Container"+(i+1));t.add(s)},this)},getNewDealer:function(){this.dealer=new i;return this.dealer},awardCards:function(){var e=this.get("deck"),t=[];if(this.dealer){_.range(5).forEach(function(a){var i=this.dealer.getRandomCard();i.set("id",this.getUniqueCardId());e.add(i);t.push(i.toJSON())},this)}return t},getUniqueCardId:function(){var e=this.get("uniqueCardId"),t="card-"+e;e++;this.set("uniqueCardId",e);return t},isCardsInSystem:function(e){var t=this.get("deck"),a=t.pluck("systemId"),i=a.indexOf(e);if(i>=0){return true}else return false},updateVoid:function(e){var t=[];for(var a=0;a<e.length;a++){t[a]=e[a].id}this.set("voidCards",t)}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.config"),t=Omega.require("Omega.Models.Model"),a=Omega.require("Omega.Models.SystemModel"),i=Omega.require("Omega.Collections.SystemCollection"),s=Omega.require("Omega.Utils.GalaxyBuilder");Omega.Models.GalaxyModel=t.extend({localStorage:new Backbone.LocalStorage("gwdb_galaxy"),relations:[{type:Backbone.HasMany,key:"systems",relatedModel:"Omega.Models.SystemModel",collectionType:"Omega.Collections.SystemCollection",reverseRelation:{key:"galaxyId",includeInJSON:true}}],defaults:function(){return{seed:0,galaxySize:1,playerFaction:0,systems:new i,edges:[],selectedSystemId:null,moveMode:null,moveUndo:null,moveDistances:[1,1,1,1]}},initialize:function(e,t){e=e||{};this.random=new Jaff.Random},build:function(){var e=new s({seed:this.get("seed"),size:this.get("galaxySize")});e.build();this.set("edges",e.getEdges());this.buildSystems(e);this.setupFactions()},buildSystems:function(e){var t=[],a=e.getPoints(),s=e.getConnections(),n=e.getDistantPoints(4),o=this.buildSystemNames(a.length),r=false,l=0,d=new i;this.random.seed(this.get("seed"));for(var c=0;c<a.length;c++){r=n.indexOf(c)!==-1;t[c]={name:o[c],id:"system-"+c,isCommander:r,faction:r?l:-1,position:a[c],edges:_.map(s[c],function(e){return JSON.stringify([a[c],a[e]])}),connections:_.map(s[c],function(e){return"system-"+e}),planets:this.buildPlanets(o[c])};if(r)l++}d.reset(t);this.set("systems",d)},buildSystemNames:function(t){var a;var i=0;var s=[];_.each(e.systemNames,function(e){a=_.random(i++);s[i-1]=s[a];s[a]=e});return s.splice(0,t)},buildPlanets:function(t){var a=[" I"," II"," III"," IV"," V"," VI"," VII"," VIII"," IX"," X"];var i=Math.floor(this.random.next()*e.planetTemplates.length);var s=e.planetTemplates[i];var n=s&&s.planets.map(function(e,i){return _.extend({},e,{name:t+a[i]})},this);return n||[]},setupFactions:function(){var e=this.get("systems"),t=[];_.range(4).forEach(function(a){var i=e.get(this.getCommanderPosition(a));i.get("connections").forEach(function(a){var s=e.get(a),n=s.get("faction"),o=s.get("isCommander");if(n==-1&&!o){s.set("faction",i.get("faction"))}else if(n>=0&&!o){t.push(s)}})},this);t.forEach(function(e){e.set("faction",-1)})},getValidMoveEdges:function(e){var t=this.get("moveMode"),e=e>=0?e:this.get("playerFaction"),a=this.getCommanderPosition(e),i=this.get("systems"),s=i.get(a),n=this.get("moveDistances")[e],o=[];if(t&&s){o=n>0?s.get("edges").slice(0):[];if(n==2){o=s.get("connections").reduce(function(e,t){return e.concat(i.get(t).get("edges"))},o);o=_.unique(o)}o=o.map(function(e){return JSON.parse(e)})}return o},getCommanderPosition:function(e){var t=this.get("systems");var a=t.map(function(t){return t.get("faction")==e&&t.get("isCommander")?t.id:false});a=_.compact(a);return a[0]},isValidMove:function(e,t){var a=this.get("systems"),i=a.get(e),s=i&&i.get("faction")==this.get("playerFaction")&&i.get("isCommander"),n=i&&_.contains(i.get("connections"),t);return s&&n},selectSystem:function(e){var t=this.get("selectedSystemId"),a=this.getCommanderPosition(this.get("playerFaction")),i=this.isValidMove(a,e);this.set("isValidMove",i);this.set("selectedSystemId",e);this.trigger("selectSystem",e);if(false&&testMoveLogic){this.moveCommander(t,e);this.AIMove();this.trigger("moveCommander",t,e)}},moveCommander:function(){var e=this.get("systems"),t=this.get("playerFaction"),a=this.getCommanderPosition(t),i=this.get("selectedSystemId");if(a&&i){this.doMoveCommander(a,i);this.trigger("moveCommander")}},undoMoveCommander:function(){this.doUndoMoveCommander();this.trigger("moveCommander")},resolveRound:function(e){this.battleResults=_.range(4).map(this.getInitialState,this);this.resolvePlayerMove(e);this.playAIMoves();this.moveUndo=null;try{this.fixBoard()}catch(t){}this.battleResults=this.battleResults.map(this.computeBattleChanges,this);return this.battleResults},fixBoard:function(){var e=this.get("systems"),t=e.invoke("pick",["id","faction","isCommander"]);_.range(4).forEach(function(a){var i=t.filter(function(e){return e.faction==a}),s=i.filter(function(e){return e.isCommander});if(s.length==0&&i.length>0){e.get(i[0].id).set("isCommander",true)}else if(s.length>1){e.get(i[1].id).set("isCommander",false)}},this)},getInitialState:function(e){var t=this.getCommanderPosition(e),a=this.get("systems").get(t),i=a?a.get("name"):null;return{faction:e,commander:{lastPosition:i,newPosition:null},systemsOwned:this.getFactionSystems(e)}},computeBattleChanges:function(e){var t=this.getCommanderPosition(e.faction),a=this.getFactionSystems(e.faction),i=function(e){return this.get("systems").get(e).get("name")};e.commander.newPosition=t?i.call(this,t):null;e.systemsLost=_.difference(e.systemsOwned,a).map(i,this);e.systemsWon=_.difference(a,e.systemsOwned).map(i,this);e.systemsOwned=a.map(i,this);return e},resolvePlayerMove:function(e){var t=this.get("moveUndo"),a=t.wasCommander,i=this.get("selectedSystemId"),s=this.get("systems").get(i);if(a){if(e){this.moveBackOrDie(t.wasSystem,t.wasFaction)}else{this.doUndoMoveCommander()}}else{if(e){s.set("attackBonus",Infinity)}else{s.set("defenseBonus",Infinity)}this.resolveDieRollsAround(t.wasSystem,"player")}},playAIMoves:function(){var e=this.get("systems"),t=this.get("playerFaction"),a=e.invoke("pick",["id","faction","isCommander","connections"]).filter(function(e){return e.isCommander&&e.faction!=t});a.forEach(function(e){var t=Math.floor(e.connections.length*this.random.next()),a=e.connections[t];this.doMoveCommander(e,a);this.resolveAIMove()},this)},resolveAIMove:function(){var e=this.get("moveUndo"),t=e.wasCommander,a=this.rollDieIn(e.wasSystem);if(t){if(a){this.moveBackOrDie(e.wasSystem,e.wasFaction)}else{this.doUndoMoveCommander()}}else{this.resolveDieRollsAround(e.wasSystem,"ai")}},doMoveCommander:function(e,t){var a=this.get("systems"),i=a.get(e),s=a.get(t);this.set("moveUndo",{originalSystem:e,wasSystem:t,wasCommander:s.get("isCommander"),wasFaction:s.get("faction")});i.set("isCommander",false);s.set("isCommander",true);s.set("faction",i.get("faction"))},doUndoMoveCommander:function(){var e=this.get("systems"),t=this.get("moveUndo"),a;if(t){a=e.get(t.originalSystem);a.set("isCommander",true);a=e.get(t.wasSystem);a.set("isCommander",t.wasCommander);a.set("faction",t.wasFaction);this.set("moveUndo",null)}},resolveDieRollsAround:function(e,t){var a=this.get("systems"),i=a.get(e),s=i.get("faction"),n=i.get("connections");n.forEach(function(e){var i=a.get(e),n=i.get("faction"),o=this.rollDieIn(e,t);if(n==-1){i.set("faction",s)}else if(n!=s&&o){if(i.get("isCommander")){this.moveBackOrDie(e)}i.set("faction",s)}},this)},rollDieIn:function(e,t){var a=this.get("systems").get(e),i=this.random.next()+(t=="player"?a.get("attackBonus"):0),s=this.random.next()+(t=="ai"?a.get("defenseBonus"):0);return i>s},moveBackOrDie:function(e,t){var a=this.get("systems"),i=a.get(e),s=t>=0?t:i.get("faction"),n=i.get("connections").map(function(e){return a.get(e)}).filter(function(e){var t=e.get("faction");return t==s||t==-1});if(n.length){var o=Math.floor(n.length*this.random.next());i.set("isCommander",false);n[o].set("isCommander",true);n[o].set("faction",s)}else{var r=[];a.each(function(e){if(e.get("faction")==s){e.set("faction",-1);e.set("isCommander",false);r.push(e.id)}})}},getFactionSystems:function(e){var t=this.get("systems").invoke("pick",["id","faction"]).filter(function(t){return t.faction==e}).map(function(e){return e.id});return t.sort()},getSelectedSystem:function(){var e=this.get("selectedSystemId"),t=e&&e!=="galaxy"&&e!=="planet"?this.get("systems").get(e):null;return t}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.Model"),t=Omega.require("Omega.Models.GalaxyModel"),a=Omega.require("Omega.Models.DeckModel");Omega.Models.GameModel=e.extend({localStorage:new Backbone.LocalStorage("gwdb_game"),relations:[{type:Backbone.HasOne,key:"galaxy",relatedModel:"Omega.Models.GalaxyModel",includeInJSON:"id",reverseRelation:{key:"gameId",includeInJSON:"id"}},{type:Backbone.HasOne,key:"deck",relatedModel:"Omega.Models.DeckModel",includeInJSON:"id",reverseRelation:{key:"gameId",includeInJSON:"id"}}],defaults:{name:"Galactic War",faction:0,factionColor:0,galaxySize:1,gameDifficulty:1,seed:0,phase:1,turn:0,result:null,created:0,lastBattle:0,countSystems:0,countCards:0,isPlayCards:true,galaxy:null,deck:null,isNextPhaseEnabled:true,isPrevPhaseEnabled:false,isForceDiscard:false},initialize:function(e){var t=Math.floor(Math.random()*Math.pow(2,16));this.set("seed",t);this.set("created",Date.now());this.set("lastBattle",Date.now())},nextPhase:function(){var e=this.get("phase"),t=this.get("deck");this.trigger("checkForceDiscard");if(this.get("isNextPhaseEnabled")&&!this.get("isForceDiscard")){this.setPhase(e+1,+1);this.trigger("phaseNext")}},prevPhase:function(){var e=this.get("phase");if(this.get("isPrevPhaseEnabled")){this.setPhase(e-1,-1);this.trigger("phaseUndo")}},setPhase:function(e,t){var a=this.get("phase"),i=Math.max(1,Math.min(e%8,7)),s=this.get("galaxy"),n=this.get("deck");if(i==6){this.trigger("saveCards");this.trigger("playPA");return}if(i==1){this.set("phase",1);if(t>0){this.set("lastBattle",Date.now());this.selectSystem();this.set("isPlayCards",true);this.set("turn",this.get("turn")+1)}this.set("isPrevPhaseEnabled",false)}if(i!=a){this.set("phase",i);if(s){if(i==1){s.selectSystem("galaxy");n.selectSystem("galaxy");n.setPlayArea("galaxy")}if(i==2){var o=s.get("systems"),r=s.get("playerFaction"),l=o.findWhere({isCommander:true,faction:r});this.selectSystem(l.get("id"))}if(i==3){s.selectSystem("planet");n.selectSystem("planet");n.setPlayArea("planet")}if(i==5&&a==4)s.moveCommander();if(i==4&&a==5)s.undoMoveCommander();s.set("moveMode",i==4?"move":i==5?"attack":null)}}if(i>1)this.set("isPrevPhaseEnabled",true);this.setIsNextEnabled();if(i==4&&i>a){this.applyCards("move","galaxy")}},applyCards:function(e,t){var a=this.get("deck"),i=this.get("galaxy"),s=t=="galaxy"?i:t=="dealer"?a.getNewDealer():null;if(a&&s){a.get("deck").filter(function(a){return a.isInPlay()&&a.canApply(e,t)}).forEach(function(e){e.applyEffect(s)})}},setIsNextEnabled:function(){var e=this.get("galaxy"),t=!e.get("moveMode")||e.get("isValidMove")||this.get("phase")==7;this.set("isNextPhaseEnabled",t)},selectSystem:function(e){var t=this.get("galaxy"),a=this.get("deck");if(t){t.selectSystem(e);this.setIsNextEnabled()}if(a){a.selectSystem(e);if(t.get("selectedSystemId")!==null&&t.get("selectedSystemId")!==undefined)a.setPlayArea("system");else a.setPlayArea("galaxy")}},nextSystem:function(){var e=false,t=this.get("galaxy"),a=this.get("deck"),i=t.get("selectedSystemId"),s=t.get("systems").pluck("id"),n=s.indexOf(i)+1;if(n<s.length){for(var o=n;o<s.length;o++){if(a.isCardsInSystem(s[o])){this.selectSystem(s[o]);e=true;break}}}if(!e){if(t)t.selectSystem("planet");a.selectSystem("planet");a.setPlayArea("planet")}},prevSystem:function(){var e=false,t=this.get("galaxy"),a=this.get("deck"),i=t.get("selectedSystemId"),s=t.get("systems").pluck("id"),n=i=="planet"?s.length-1:s.indexOf(i)-1;if(n>0){for(var o=n;o>=0;o--){if(a.isCardsInSystem(s[o])){this.selectSystem(s[o]);e=true;break}}}if(!e){if(t)t.selectSystem("galaxy");a.selectSystem("galaxy");a.setPlayArea("galaxy")}},resolveRound:function(e){var t=this.resolveDieRolls(),a=this.resolveCards();this.set("playerWonPA",e);this.set("isPlayCards",false);this.set("factionResults",t);this.set("awardedCards",a);this.setPhase(7)},resolveDieRolls:function(e){this.applyCards("dieRoll","galaxy");return this.get("galaxy").resolveRound(e)},resolveCards:function(){this.applyCards("dealCards","dealer");return this.get("deck").awardCards()}})});Omega.define(function(){"use strict";Omega.Models.Model=Backbone.RelationalModel});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.Model");Omega.Models.PlanetModel=e.extend({defaults:{name:"Planet",mass:0,density:0,position_x:0,position_y:0,velocity_x:0,velocity_y:0,planet:{biome:"earth",biomeScale:0,heightRange:0,metalClusters:0,metalDensity:0,radius:0,seed:0,temperature:0,waterHeight:0}}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.Model"),t=Omega.require("Omega.Models.PlanetModel"),a=Omega.require("Omega.Collections.PlanetCollection");Omega.Models.SystemModel=e.extend({localStorage:new Backbone.LocalStorage("gwdb_galaxy"),relations:[{type:Backbone.HasMany,key:"planets",relatedModel:"Omega.Models.PlanetModel",collectionType:"Omega.Collections.PlanetCollection",reverseRelation:{key:"systemId",includeInJSON:true}}],defaults:function(){return{name:"Unnamed",faction:0,isCommander:false,position:[0,0],edges:[],connections:[],planets:new a,attackBonus:0,defenseBonus:0}},increaseBonus:function(e,t){this.attributes.attackBonus+=e||0;this.attributes.defenseBonus+=t||0},resetBonus:function(){this.attributes.attackBonus=0;this.attributes.defenseBonus=0}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.CardModel");Omega.Models.Cards.CardDealCardModel=e.extend({defaults:{applyPhase:"dealCards",effectTarget:"dealer"},applyEffect:function(e){var t=e.getCards(),a=this.get("effectType"),i,s,n,o;i=a.split("-");s=i[0];n=i[1]=="plus";o=t.map(function(e){return s=="rare"&&e.weight<=2||e.type==s});if(o){o.forEach(function(e,a){if(!e)return;if(s=="rare"){t[a].weight=t[a].rawWeight+(n?2:1)}else{t[a].weight=t[a].rawWeight*(n?4:2)}});e.setCards(t)}}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.CardModel");Omega.Models.Cards.DieRollCardModel=e.extend({defaults:{applyPhase:"dieRoll",effectTarget:"galaxy"},applyEffect:function(e){var t=e.get("systems"),a=this.get("systemId"),i=this.get("attackBonus"),s=this.get("defenseBonus"),n=this.get("range"),o;if(t.get(a)){if(n=="this-system"){o=[t.get(a)]}else if(n=="adjacent"){o=t.get(a).get("connections").map(function(e){return t.get(e)})}}else if(a=="galaxy"){if(n=="commander-adjacent"){a=e.getCommanderPosition(e.get("playerFaction"));o=t.get(a).get("connections").map(function(e){return t.get(e)})}}if(o)o.forEach(function(e){e.increaseBonus(i,s)})}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.CardModel");Omega.Models.Cards.GainControlCardModel=e.extend({defaults:{applyPhase:"dieRoll",effectTarget:"galaxy"},applyEffect:function(e){var t=e.get("systems"),a=this.get("systemId"),i=this.get("attackBonus"),s=this.get("defenseBonus"),n=this.get("range"),o;if(a!="galaxy"){if(n=="this-system"){o=[t.get(a)]}else if(n=="adjacent"){o=t.get(a).get("connections").map(function(e){return t.get(e)})}}if(o)o.forEach(function(e){e.increaseBonus(i,s)})}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Models.CardModel");Omega.Models.Cards.PlanetCardModel=e.extend({defaults:{type:"planet"}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.config.cards"),t=Omega.require("Omega.Models.CardModel"),a=["CardModel"].concat(t.subModelNames),i=_.values(t.subModelTypes).map(function(e){return Omega.require(e)}),s=[t].concat(i);Omega.Utils.CardDealer=function(){this.initialize.apply(this,arguments)};Omega.Utils.CardDealer.prototype={initialize:function(t){t=t||{};this.rawCards=t.cards||e;this.reset();this.random=new Jaff.Random(t.seed);this.random.seed()},reset:function(){this.cards=this.rawCards.map(function(e){return _.extend({},e,{rawWeight:e.weight})})},getCards:function(){return this.cards},setCards:function(e){this.cards=e},getRandomCard:function(e){var t=["galaxy","system","planet"],a=t.indexOf(e),i=this.cards.reduce(function(e,i){var s=a==-1||i.type==t[a],n=s?i.weight:0;return e+n},0),s=this.getRandomLocation(i),n=this.cards.filter(function(e){var i=a==-1||e.type==t[a],n=i?e.weight:0,o=s>=0&&s-n<0;s-=n;return o});n=n.length==0?{}:n[0];return this.makeCard(n)},getRandomLocation:function(e){return Math.floor(this.random.next()*e)},makeCard:function(e){var t=a.indexOf(e.model),i=t==-1?s[0]:s[t];return new i(e)}}});Omega.define(function(){"use strict";Omega.Utils.Delaunay=function(){this.initialize.apply(this,arguments)};Omega.Utils.Delaunay.prototype={initialize:function(t){this.points=t||[];this.triangles=e(this.points)},getTriangles:function(){return this.triangles},getOuterPoints:function(){var e,t,a,i=this.getOuterEdges(),s=i[0].slice(0),n=1;for(e=0;e<i.length-1;e++){for(t=e+1;t<i.length;t++){if(i[e][n]==i[t][0]||i[e][n]==i[t][1]){a=i[e+1];
i[e+1]=i[t];i[t]=a;if(i[e][n]==i[e+1][0]){s.push(i[e+1][1]);n=1}if(i[e][n]==i[e+1][1]){s.push(i[e+1][0]);n=0}}}}s.pop();return s},getEdges:function(){var e=this.getAllEdges();e=_.uniq(e,function(e){return e.join(".")}).sort(function(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:e[1]<t[1]?-1:e[1]>t[1]?1:0});return e},getOuterEdges:function(){var e,t=this.getAllEdges(),a={};_.each(t,function(t){e=t.join(".");a[e]=(a[e]||0)+1});t=_.filter(t,function(t){e=t.join(".");return a[e]==1}).sort(function(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:e[1]<t[1]?-1:e[1]>t[1]?1:0});return t},getAllEdges:function(){var e,t,a=[];for(e=0;e<this.triangles.length;e++){t=this.triangles[e].slice(0).sort();a.push(this.fixEdge([t[0],t[1]]));a.push(this.fixEdge([t[0],t[2]]));a.push(this.fixEdge([t[1],t[2]]))}return a},fixEdge:function(e){var t=e[0]>e[1]?[e[1],e[0]]:[e[0],e[1]];return t},getConnections:function(){var e=[];e=this.points.map(function(){return[]});this.triangles.forEach(function(t){e[t[0]].push(t[1],t[2]);e[t[1]].push(t[2],t[0]);e[t[2]].push(t[0],t[1])});e=e.map(function(e){return _.uniq(e.sort())});return e}};function e(e){var s=e.length,n,o,r,l,d,c,h,m,g,u,p;if(s<3)return[];e=e.slice(0);r=new Array(s);for(n=s;n--;)r[n]=n;r.sort(function(t,a){return e[a][0]-e[t][0]});t(e);l=[a(e,s+0,s+1,s+2)];d=[];c=[];for(n=r.length;n--;){p=r[n];c.length=0;for(o=l.length;o--;){h=e[p][0]-l[o].x;if(h>0&&h*h>l[o].r){d.push(l[o]);l.splice(o,1);continue}m=e[p][1]-l[o].y;if(h*h+m*m>l[o].r)continue;c.push(l[o].i,l[o].j,l[o].j,l[o].k,l[o].k,l[o].i);l.splice(o,1)}i(c);for(o=c.length;o;){u=c[--o];g=c[--o];l.push(a(e,g,u,p))}}for(n=l.length;n--;)d.push(l[n]);l.length=0;for(n=d.length;n--;)if(d[n].i<s&&d[n].j<s&&d[n].k<s)l.push([d[n].i,d[n].j,d[n].k]);return l}function t(e){var t=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY,n,o,r,l,d,c;for(n=e.length;n--;){if(e[n][0]<t)t=e[n][0];if(e[n][0]>i)i=e[n][0];if(e[n][1]<a)a=e[n][1];if(e[n][1]>s)s=e[n][1]}o=i-t;r=s-a;l=Math.max(o,r);d=t+o*.5;c=a+r*.5;e.push([d-20*l,c-l],[d,c+20*l],[d+20*l,c-l])}function a(e,t,a,i){var s=e[t],n=e[a],o=e[i],r=n[0]-s[0],l=n[1]-s[1],d=o[0]-s[0],c=o[1]-s[1],h=r*(s[0]+n[0])+l*(s[1]+n[1]),m=d*(s[0]+o[0])+c*(s[1]+o[1]),g=2*(r*(o[1]-n[1])-l*(o[0]-n[0])),u,p,f,y,v,C;if(Math.abs(g)<1e-6){u=Math.min(s[0],n[0],o[0]);p=Math.min(s[1],n[1],o[1]);f=(Math.max(s[0],n[0],o[0])-u)*.5;y=(Math.max(s[1],n[1],o[1])-p)*.5;v=u+f;C=p+y}else{v=(c*h-l*m)/g;C=(r*m-d*h)/g;f=v-s[0];y=C-s[1]}return{i:t,j:a,k:i,x:v,y:C,r:f*f+y*y}}function i(e){var t=e.length,a,i,s,n,o;e:while(t){i=e[--t];a=e[--t];s=t;while(s){o=e[--s];n=e[--s];if(a===n&&i===o||a===o&&i===n){e.splice(t,2);e.splice(s,2);t-=2;continue e}}}}});Omega.define(function(){"use strict";var e=Omega.require("Omega.Utils.PointField"),t=Omega.require("Omega.Utils.Graph"),a=Omega.require("Omega.Utils.Delaunay");Omega.Utils.GalaxyBuilder=function(){this.initialize.apply(this,arguments)};Omega.Utils.GalaxyBuilder.prototype={initialize:function(e){e=e||{};this.seed=e.seed||0;this.size=e.size||0;this.starCount=[20,40,80,160][this.size]},build:function(){this.buildStars();this.buildGraph()},buildStars:function(){var t=new e({seed:this.seed,size:this.starCount,density:160});t.build();this.stars=t.getPoints()},buildGraph:function(){this.graph=new a(this.stars);this.reducedGraph=new t(this.graph.getEdges());this.reducedGraph.reduceConnections(4);this.edges=this.reducedGraph.getEdges().map(function(e){return[this.stars[e[0]].slice(0),this.stars[e[1]].slice(0)]},this)},getPoints:function(){return this.stars.slice(0)},getEdges:function(){return this.edges.slice(0)},getConnections:function(){return this.reducedGraph.getConnections()},getOuterPoints:function(){return this.graph.getOuterPoints()},getDistantPoints:function(e){var t=this.getOuterPoints(),a=_.range(4).map(function(e){e=Math.floor(e*t.length/4);return t[e]});return a.sort()}}});Omega.define(function(){"use strict";Omega.Utils.Graph=function(){this.initialize.apply(this,arguments)};Omega.Utils.Graph.prototype={initialize:function(e){this.edges=[];this.connections=[];if(e)e.forEach(this.addEdge,this)},addEdge:function(e){var e=this.fixEdge(e);this.edges.push(e);this.connections[e[0]]=this.connections[e[0]]||[];this.connections[e[1]]=this.connections[e[1]]||[];this.connections[e[0]].push(e[1]);this.connections[e[1]].push(e[0])},removeEdge:function(e){var t=this.fixEdge(e);this.edges=this.edges.filter(function(e){return e[0]!=t[0]||e[1]!=t[1]});this.connections[t[0]]=_.without(this.connections[t[0]],t[1]);this.connections[t[1]]=_.without(this.connections[t[1]],t[0])},fixEdge:function(e){var t=e[0]>e[1]?[e[1],e[0]]:[e[0],e[1]];return t},getEdges:function(){return this.edges.sort(function(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:e[1]<t[1]?-1:e[1]>t[1]?1:0})},getConnections:function(){return this.connections.slice(0)},isConnected:function(){var e=_.range(this.connections.length),t=[0],a=[0],i,s,n,o;while(t.length<this.connections.length){i=t.length-1;s=t[i];n=a[i];if(n>=this.connections[s].length){t.pop();a.pop();a[a.length-1]++}else{o=this.connections[s][n];if(e[o]==null){a[i]++}else{t.push(o);a.push(0)}e[o]=null}if(a.length==0)return false;if(_.compact(e).length==0)return true}},reduceConnections:function(e,t){var a=new Jaff.Random(t),i=_.compact(this.connections.map(function(t,a){return t.length>e?a:null})),s=[],n=1e3;while(i.length>0&&n>0){var o=i[Math.floor(a.next()*i.length)],r=Math.floor(a.next()*this.connections[o].length),l=[o,this.connections[o][r]];this.removeEdge(l);if(this.isConnected()){s.push(l);i=_.compact(this.connections.map(function(t,a){return t.length>e?a:null}))}else{this.addEdge(l)}n--}}}});Omega.define(function(){"use strict";Omega.Utils.PointField=function(){this.initialize.apply(this,arguments)};Omega.Utils.PointField.prototype={initialize:function(e){e=e||{};this.size=e.size||1;this.density=e.density||1;this.minimumDistance=e.minimumDistance||1;this.minimumDistanceSq=this.minimumDistance*this.minimumDistance;this.maximumDistance=e.maximumDistance||2;this.deltaDistance=this.maximumDistance-this.minimumDistance;this.random=new Jaff.Random(e.seed)},build:function(){var e,t;this.points=[[0,0]];while(this.points.length<this.size){e=Math.floor(this.random.next()*this.points.length);t=this.generateNewPoint(this.points[e]);if(this.isValidPoint(t))this.points.push(t)}this.fixDensity();return this},generateNewPoint:function(e){var t=this.random.next()*2*Math.PI,a=this.minimumDistance+this.deltaDistance*this.random.next();return[e[0]+a*Math.cos(t),e[1]+a*Math.sin(t)]},isValidPoint:function(e){return this.points.every(function(t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])>=this.minimumDistanceSq},this)},fixDensity:function(){var e=[0,0],t=[0,0];this.points.forEach(function(a){e[0]=Math.min(e[0],a[0]);e[1]=Math.min(e[1],a[1]);t[0]=Math.max(t[0],a[0]);t[1]=Math.max(t[1],a[1])});var a=Math.sqrt(this.size/this.density),i=a/Math.max(t[0]-e[0],t[1]-e[1]),s=(1-a)/2;this.points=this.points.map(function(t){t[0]=s+(t[0]-e[0])*i;t[1]=s+(t[1]-e[1])*i;return t})},getPoints:function(){return this.points.slice(0)}}});Omega.define(function(){"use strict";_.templateSettings={evaluate:/<<=(.+?)>>/g,interpolate:/\{\{(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g};Omega.Utils.Template=function(e){this.initialize(e)};Omega.Utils.Template.prototype={initialize:function(e){this.id=e;this.template=_.template($(e).html())},build:function(e){e=e||{};e.t=function(e){return Omega.environment.localizedStrings[e]||""};var t="";try{t=this.template(e)}catch(a){t="<!-- "+a.name+": "+a.message+" -->"}return t}}});Omega.define(function(){"use strict";var e=Omega.require("Omega.environment"),t=Omega.require("Omega.Views.View"),a=Omega.require("Omega.Utils.Template"),i=t.prototype;Omega.Views.CardsView=t.extend({template:new a("#cardsTemplate"),factionResultsTemplate:new a("#factionResultsTemplate"),awardedCardTemplate:new a("#awardedCardTemplate"),events:{"click .minimize_button":"onToggleExpand","click .closed_panel":"onTrayClick","click .arrow_left":"onPrevClick","click .arrow_right":"onNextClick"},initialize:function(e){i.initialize.apply(this,e);this.model=e.model;this.deck=this.model.get("deck");this.listenTo(this.deck,"changePlayArea",this.onPlayAreaChange);this.listenTo(this.model,"checkForceDiscard",this.checkForceDiscard);this.listenTo(this.model,"phaseUndo",this.onPhaseUndo);this.listenTo(this.model,"phaseNext",this.onPhaseNext);this.listenTo(this.model,"saveCards",this.saveCardLocations)},render:function(){var e=this.model.toJSON(),t,a;if(!this.model.get("isPlayCards")){e.paResult=e.playerWonPA?"won":"lost";e.factionResults=e.factionResults.map(function(t){t.color=(t.faction-e.faction+e.factionColor+4)%4;return t});a=_.map(e.factionResults,this.factionResultsTemplate.build,this.factionResultsTemplate);e.playerResultsHTML=a.splice(e.faction,1).join(" ");e.enemyResultsHTML=a.join(" ");e.awardedCardsHTML=_.map(e.awardedCards,this.awardedCardTemplate.build,this.awardedCardTemplate).join(" ")}t=this.template.build(e);this.$el.html(t);this.buildCards();this.enableDragAndDrop();if(this.model.get("phase")==7)this.disableCards();else this.disableCards("galaxy")},buildCards:function(){var e=this.deck.get("deck"),t=new a("#cardTemplate"),i=_.compact(e.map(function(e){return e.get("lastLocation")=="voidContainer"?e.id:null})),s=i.length<11?i.length:10;$("#tray .cardPanel").each(function(){var t=$(this).attr("id"),i=t.replace("Tray",""),s=_.compact(e.map(function(e){return e.get("type")==i?e.id:null})),n=new a("#cardTemplate");$(this).children(".card_container").each(function(t){var a=$(this).attr("id");var i=e.findWhere({lastLocation:a});var s=i&&i.toJSON(),o=s?n.build(s):"";$(this).html(o)})});for(var n=0;n<s;n++){var o=e.get(i[n]),r=o&&o.toJSON(),l=r?t.build(r):"";$("#voidContainer").append(l)}$("#voidContainer").children().addClass("voided");$("#tray .card, #discard .card:not(.voided)").draggable({cursor:"move",revert:"invalid",helper:"original",zIndex:10,opacity:.7,stop:function(e,t){$(this).css({top:"",left:"","z-index":"",opacity:""})}});$("#tray .disabled .card, #discard .card:not(.voided)").draggable("disable");if(this.model.get("phase")==7){this.dealAwardedCards()}else this.adjustTrayCapacity()},dealAwardedCards:function(){var e=this.deck.get("deck"),t=new a("#cardTemplate"),i=_.last(e.models,5);for(var s=0;s<i.length;s++){var n=i[s],o=n.get("id"),r=n.get("type"),l=n&&n.toJSON(),d=l?t.build(l):"";$("#"+r+"Tray").children().each(function(){if($(this).children().length===0){var t=e.get(o);t.set("lastLocation",$(this).attr("id"));$(this).html(d);return false}})}this.adjustTrayCapacity();$("#tray .card").draggable({cursor:"move",revert:"invalid",helper:"original",zIndex:10,opacity:.7,stop:function(e,t){$(this).css({top:"",left:"","z-index":"",opacity:""})}});$("#tray .disabled .card").draggable("disable")},adjustTrayCapacity:function(){$("#tray .cardPanel").each(function(){var e=$(this).attr("id"),t=0;$(this).children(".card_container").slice(7,12).each(function(){if($(this).children().length>0)t++});switch(t){case 1:$(this).removeClass("layout_7 layout_8 layout_9 layout_10 layout_11 layout_12").addClass("layout_8");break;case 2:$(this).removeClass("layout_7 layout_8 layout_9 layout_10 layout_11 layout_12").addClass("layout_9");break;case 3:$(this).removeClass("layout_7 layout_8 layout_9 layout_10 layout_11 layout_12").addClass("layout_10");break;case 4:$(this).removeClass("layout_7 layout_8 layout_9 layout_10 layout_11 layout_12").addClass("layout_11");break;case 5:$(this).removeClass("layout_7 layout_8 layout_9 layout_10 layout_11 layout_12").addClass("layout_12");break;default:break}})},enableDragAndDrop:function(){$("#tray .card").draggable({cursor:"move",revert:"invalid",helper:"original",zIndex:10,opacity:.7,stop:function(e,t){$(this).css({top:"",left:"","z-index":"",opacity:""})}});$("#tray .disabled .card:not(.voided)").draggable("disable");$(".starmap").droppable({drop:$.proxy(function(e,t){var a=t.draggable.context.getAttribute("data-type"),i=this;if(document.getElementById("play_cards").classList.contains(a)){$("#play_cards .card_container").each(function(){if($(this).children().length===0){i.updateCardSystemId(t.draggable.context.id,this.parentNode.getAttribute("data-system-id"),a);i.updateCardLocation(t.draggable.context.id,$(this).attr("id"));$(this).append(t.draggable.context);return false}})}else return false},this),tolerance:"pointer",accept:$.proxy(this,function(e){var t=false,a=e.context.getAttribute("data-type");if(document.getElementById("play_cards").classList.contains(a)){$("#play_cards .card_container").each(function(){if($(this).children().length===0){t=true;return false}})}return t})});$("#discard .card_container").droppable({drop:$.proxy(function(e,t){this.updateCardLocation(t.draggable.context.id,e.target.id);e.target.appendChild(t.draggable.context);this.updateCardSystemId(t.draggable.context.id,"","void");this.deck.updateVoid(e.target.children)},this),tolerance:"pointer",out:function(){$(".starmap").droppable("disable")}});$("#play_cards, #card_ui_backstop").droppable({drop:function(e,t){return false},tolerance:"pointer",over:function(){$(".starmap").droppable("disable")},out:function(){$(".starmap").droppable("enable")}});$("#tray .card_container, #play_cards .card_container").droppable({drop:$.proxy(this.onDrop,this),tolerance:"pointer",over:function(){$(".starmap").droppable("disable")}});$("#tray .disabled .card_container").droppable("disable")},onPhaseUndo:function(){this.onPhaseChange(-1)},onPhaseNext:function(){this.onPhaseChange(1)},onPhaseChange:function(e){var t=this.model.get("phase"),a,i;switch(t){case 1:a="galaxy";i="system";break;case 2:a="system";i="planet";break;case 3:a="planet";break;default:break}if(t<3&&e<0)this.loadPreviousCardLocations(i);this.switchTray(a);this.disableCards(a)},switchTray:function(e){var t=$("#"+e+"Tray");$("#tray").removeClass("noTransition");if(t.length&&!t.hasClass("open_panel")){$(".open_panel").removeClass("open_panel").addClass("closed_panel").find(".card_container").droppable("disable").find(".card").draggable("disable");t.removeClass("closed_panel").addClass("open_panel").css({left:0}).find(".card_container").droppable("enable");$(".closed_panel").removeClass("last_closed");$(".closed_panel:last").css({left:"50%"}).addClass("last_closed");$(".closed_panel:first").css({left:0})}},disableCards:function(e){switch(e){case 1:case"galaxy":$("#galaxyTray").removeClass("disabled").addClass("enabled").children().droppable("enable");$("#systemTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$("#planetTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$(".system_card:not(.voided), .planet_card:not(.voided)").addClass("disabled").removeClass("enabled").draggable("disable");$(".galaxy_card:not(.voided)").not(".voided").removeClass("disabled").addClass("enabled").draggable("enable");break;case 2:case"system":$("#systemTray").removeClass("disabled").addClass("enabled").children().droppable("enable");$("#galaxyTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$("#planetTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$(".galaxy_card:not(.voided), .planet_card:not(.voided)").addClass("disabled").removeClass("enabled").draggable("disable");$(".system_card:not(.voided)").removeClass("disabled").addClass("enabled").draggable("enable");break;case 3:case"planet":$("#planetTray").removeClass("disabled").addClass("enabled").children().droppable("enable");$("#galaxyTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$("#systemTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$(".galaxy_card:not(.voided), .system_card:not(.voided)").addClass("disabled").removeClass("enabled").draggable("disable");$(".planet_card:not(.voided)").removeClass("disabled").addClass("enabled").draggable("enable");break;default:$("#planetTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$("#galaxyTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$("#systemTray").addClass("disabled").removeClass("enabled").children().droppable("disable");$("#tray .card, #discard .card:not(.voided), #play_cards .card").addClass("disabled").removeClass("enabled").draggable("disable");break}},onToggleExpand:function(e){$(e.target).toggleClass("activated");$("#tray, #discard, #play_cards, #card_ui_backstop").toggleClass("minimized");if($("#tray").hasClass("minimized")){$("#tray .open_panel .card").draggable("disable")}else{$("#tray .open_panel .card").draggable("enable")}},onTrayClick:function(e){var t=$(e.target).parents(".closed_panel").length?$(e.target).parents(".closed_panel"):$(e.target);$("#tray").removeClass("noTransition");$(".open_panel").removeClass("open_panel").addClass("closed_panel").children().droppable("disable").find(".card").draggable("disable");t.bind("mouseleave",function(){t.removeClass("noHover");t.unbind("mouseleave")});t.removeClass("closed_panel").addClass("open_panel noHover").css({left:0});if(t.hasClass("enabled")){t.children().droppable("enable").find(".card").draggable("enable")}$(".closed_panel").removeClass("last_closed");$(".closed_panel:last").css({left:"50%"}).addClass("last_closed");$(".closed_panel:first").css({left:0})},onPrevClick:function(){this.trigger("prevSystem")},onNextClick:function(){this.trigger("nextSystem")},onPlayAreaChange:function(){if(!this.model.get("isPlayCards"))return;var e=this.deck.get("playArea"),t=this.deck.get("systemId")!==null&&this.deck.get("systemId")!==undefined?this.deck.get("systemId"):e,i=this.deck.get("deck"),s=i.where({systemId:t}),n=this.model.get("phase"),o=this.model.get("galaxy");$("#play_cards").removeClass("galaxy system planet").addClass(e).attr("data-system-id",t).find(".card_container").empty().each(function(){for(var e=0;e<s.length;e++){if($(this).attr("id")==s[e].attributes.location){var t=s[e].id,n=i.get(t),o=new a("#cardTemplate"),r=n.toJSON(),l=o.build(r);$(this).html(l)}}});$("#play_cards .card").draggable({cursor:"move",revert:"invalid",helper:"original",zIndex:10,opacity:.7,stop:function(e,t){$(this).css({top:"",left:"","z-index":"",opacity:""})}});switch(e){case"galaxy":t="galaxy";$("#play_cards .panel_heading").html("<span class='selected_system'>"+t+"</span><span class='arrow_right'></span>");break;case"system":var r=o.get("selectedSystemId"),l=o.get("systems").get(r),d=l?l.get("name"):null;$("#play_cards .panel_heading").html("<span class='arrow_left'></span><span class='selected_system'>"+d+"</span><span class='arrow_right'></span>");break;case"planet":t="planet";$("#play_cards .panel_heading").html("<span class='arrow_left'></span><span class='selected_system'>"+t+"</span>");break}this.disableCards(n)},onDrop:function(e,t){var a=t.draggable.context,i=e.target,s=a.getAttribute("data-type"),n=a.parentNode.id;if(i.firstElementChild){if(!i.firstElementChild.classList.contains("disabled")){this.updateCardSystemId(i.firstElementChild.id,a.parentNode.getAttribute("data-system-id"),s);this.updateCardLocation(i.firstElementChild.id,a.parentNode.id);a.parentNode.appendChild(i.firstElementChild);this.updateCardSystemId(a.id,i.parentNode.getAttribute("data-system-id"),s);this.updateCardLocation(a.id,i.id);i.appendChild(a)}else{return false}}else{if(i.parentNode.id=="play_cards"){var o=i.parentNode.classList;if(i.parentNode.classList.contains(s)){this.updateCardSystemId(a.id,i.parentNode.getAttribute("data-system-id"),s);this.updateCardLocation(a.id,i.id);i.appendChild(a)}else return false}else{this.updateCardSystemId(a.id,i.parentNode.getAttribute("data-system-id"),s);this.updateCardLocation(a.id,i.id);i.appendChild(a)}}if(i.id=="voidContainer"||n=="voidContainer"){this.deck.updateVoid(document.getElementById("voidContainer").children);this.updateCardSystemId(a.id,"",null)}},updateCardLocation:function(e,t){var a=this.deck.get("deck"),i=a.get(e),s=i.get("lastLocation");i.set("location",t)},updateCardSystemId:function(e,t,a){var i=this.deck.get("deck"),s=i.get(e);if(a=="system"){s.set("systemId",t)}else{s.set("systemId",a)}},saveCardLocations:function(){var e=this.deck.get("deck"),t=e.filter(function(e){return e.attributes.systemId&&e.attributes.systemId!=="void"}),a=e.models.length-t.length>36?36:e.models.length-t.length;for(var i=0;i<t.length;i++){var s=t[i].get("id");e.remove(s)}for(var i=0;i<a;i++){var s=e.models[i].get("id"),n=e.models[i].get("location");if(n){e.models[i].set("lastLocation",n);e.models[i].set("location",null)}}},loadPreviousCardLocations:function(e){var t=this.deck.get("deck");var i=t.where({type:e}),s=i.length<13?i.length:12,n=new a("#cardTemplate");$("#"+e+"Tray .card_container").html("");for(var o=0;o<s;o++){var r=i[o],l=r.get("location"),d=r.get("lastLocation"),c=r.get("systemId"),h=r&&r.toJSON(),m=h?n.build(h):"";if(l){if(c==document.getElementById("play_cards").getAttribute("data-system-id")||c=="void"){document.getElementById(l).lastElementChild.remove()}r.set("location",d).set("systemId",null)}if(d!=="voidContainer")$("#"+d).html(m)}$("#tray .card").draggable({cursor:"move",revert:"invalid",helper:"original",zIndex:10,opacity:.7,stop:function(e,t){$(this).css({top:"",left:"","z-index":"",opacity:""})}})},checkForceDiscard:function(){var e=this.model.get("phase"),t=false,a=[null,"galaxy","system","planet"],i=0;this.model.set("isForceDiscard",t);if(e>0&&e<4){$("#"+a[e]+"Tray .card_container").each(function(){if($(this).children().length>0)i++;if(i>7){t=true;return false}});this.model.set("isForceDiscard",t)}}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Views.View"),t=Omega.require("Omega.Utils.Template"),a=e.prototype;Omega.Views.CurrentTargetView=e.extend({template:new t("#currentTargetTemplate"),planetTemplate:new t("#currentTargetPlanetTemplate"),events:{},initialize:function(e){a.initialize.apply(this,e);this.model=e.model;this.addWindowEvent("resize",_.debounce(this.resize,200))},render:function(e){var t,a,i;if(this.model){t=this.model.toJSON();t.isGalaxy=false;if(t.planets.length){t.planetsHtml=_.map(t.planets,this.planetTemplate.build,this.planetTemplate).join(" ")}}else{t={isGalaxy:true}}a=this.template.build(t);this.$el.html(a);this.resize()},resize:function(){var e=window.innerHeight,t=$("#play_cards").height()||0,a=e-t-this.$(".targetBoxHeader").height()-this.$(".targetBoxHeader").height()-44;this.$(".planetList").css({maxHeight:a})}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Views.View"),t=Omega.require("Omega.Utils.Template"),a=e.prototype;Omega.Views.DiscardModal=e.extend({template:new t("#discardModalTemplate"),events:{"click .button":"onClick"},render:function(){var e=this.template.build();this.$el.html(e)},onClick:function(){this.trigger("close")}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Views.PhasesBarView"),t=Omega.require("Omega.Views.CurrentTargetView"),a=Omega.require("Omega.Views.SaveMenuView"),i=Omega.require("Omega.Views.CardsView"),s=Omega.require("Omega.Views.StarmapView"),n=Omega.require("Omega.Views.DiscardModal"),o=Omega.require("Omega.Views.View"),r=Omega.require("Omega.Utils.Template"),l=Omega.require("Omega.Models.SystemModel"),d=o.prototype;Omega.Views.GameView=o.extend({template:new r("#gameTemplate"),initialize:function(t){d.initialize.apply(this,t);this.model=t.model;var n=this.model.get("galaxy");this.listenTo(this.model,"change:phase",this.handleChange);this.listenTo(this.model,"change:turn",this.handleChange);this.listenTo(this.model,"change:isForceDiscard",this.forceDiscard);this.listenTo(n,"change",this.handleGalaxyChange);this.starMap=new s({model:n});this.starMap.on("selectSystem",this.model.selectSystem,this.model);this.cardView=new i({model:this.model});this.cardView.on("prevSystem",this.model.prevSystem,this.model);this.cardView.on("nextSystem",this.model.nextSystem,this.model);this.phaseBarView=new e({model:this.model});this.phaseBarView.on("undoPhase",this.model.prevPhase,this.model);this.phaseBarView.on("nextPhase",this.model.nextPhase,this.model);this.buildCurrentTarget();this.saveMenuView=new a;this.saveMenuView.on("quit",this.quit,this)},buildCurrentTarget:function(){var e=this.model.get("galaxy"),a=e.getSelectedSystem();this.currentTargetView=new t({model:a})},render:function(){this.$el.html(this.template.build());this.renderSubview(this.starMap,".starmap");this.renderSubview(this.cardView,".card-ui");this.renderSubview(this.phaseBarView,".phases-bar");this.renderSubview(this.currentTargetView,".current-target");this.renderSubview(this.saveMenuView,".save-menu")},remove:function(){this.starMap.remove();this.cardView.remove();this.phaseBarView.remove();this.currentTargetView.remove();this.saveMenuView.remove();d.remove.apply(this)},handleChange:function(){var e=this.model.changedAttributes();if(e.hasOwnProperty("turn")){this.render()}},handleGalaxyChange:function(){var e=this.model.get("galaxy"),t=e.changedAttributes();if(t.selectedSystemId){this.currentTargetView.remove();this.buildCurrentTarget();this.$el.append('<div class="current-target">');this.renderSubview(this.currentTargetView,".current-target")}},forceDiscard:function(){this.discardModal=new n;this.discardModal.on("close",function(){this.remove()});if(this.model.get("isForceDiscard")){this.$el.append('<div class="discard-modal">');this.renderSubview(this.discardModal,".discard-modal")}},quit:function(){this.trigger("quit")}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Views.View"),t=Omega.require("Omega.Utils.Template"),a=e.prototype;Omega.Views.NewGameView=e.extend({template:new t("#newGameTemplate"),events:{"click .cancel":"onCancel","click .create":"onCreate"},initialize:function(e){a.initialize.apply(this,e);this.model=e.model},render:function(e){var t=this.model.toJSON(),a=this.template.build(t);this.$el.html(a);this.$(".galaxySize").slider({orientation:"horizontal",range:"min",value:t.galaxySize,min:0,max:3,slide:$.proxy(this.updateText,this)});this.$(".gameDifficulty").slider({orientation:"horizontal",range:"min",value:t.gameDifficulty,min:0,max:3,slide:$.proxy(this.updateText,this)});this.$(".inputBoxStyleColor").change(function(){var e=["blue","yellow","red","green"];$(".inputBoxStyleColor").removeClass(e.join(" "));var t=$(this).val();var a=e[t];$(".inputBoxStyleColor").addClass(a)})},updateText:function(e,t){var a=$(e.target).parent().find(".indicatorContainer");a.removeClass("show-0 show-1 show-2 show-3").addClass("show-"+t.value)},updateModel:function(){var e={};this.$(".inputData").each(function(){var t=$(this);e[this.name]=t.attr("name")=="name"?t.val():parseInt(t.val(),10)});e.galaxySize=this.$(".galaxySize").slider("value");e.gameDifficulty=this.$(".gameDifficulty").slider("value");this.model.set(e,{silent:true})},onCancel:function(){this.trigger("cancel")},onCreate:function(){this.updateModel();this.trigger("create")}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Views.View"),t=Omega.require("Omega.Utils.Template"),a=e.prototype;Omega.Views.PhasesBarView=e.extend({template:new t("#phasesBarTemplate"),events:{"click .phasesUndoButton":"onUndoClick","click .phasesNextButton":"onNextClick"},initialize:function(e){a.initialize.apply(this,e);this.model=e.model;this.listenTo(this.model,"change",this.handleChange)},render:function(e){var t=this.model.get("phase"),a=["galaxy","galaxy","system","planet","move","attack",null,"results"],i={phase:a[t],undo:this.model.get("isPrevPhaseEnabled")?"phaseActive":"",next:this.model.get("isNextPhaseEnabled")?"phaseActive":""},s=this.template.build(i);this.$el.html(s)},handleChange:function(){var e=this.model.changedAttributes();if(_.union(_.keys(e),["phase","isPrevPhaseEnabled","isNextPhaseEnabled"])){this.render()}},onNextClick:function(){this.trigger("nextPhase")},onUndoClick:function(){this.trigger("undoPhase")}})});Omega.define(function(){return;"use strict";var e=Omega.require("Omega.Views.View"),t=Omega.require("Omega.Utils.Template"),a=e.prototype;Omega.Views.PlanetView=e.extend({template:new t("#planetListTemplate"),events:{},initialize:function(e){a.initialize.apply(this,e);this.model=e.model},render:function(e){var t,a;t=this.model.toJSON();a=this.template.build(t);this.$el.html(a)}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Views.View"),t=Omega.require("Omega.Utils.Template"),a=e.prototype;Omega.Views.PlayingModal=e.extend({template:new t("#playingModalTemplate"),events:{"click .button":"onClick"},render:function(){var e=this.template.build();this.$el.html(e)},onClick:function(e){var t=$(e.target).attr("data-result"),a=t!="lose";this.trigger("done",a)}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Views.View"),t=Omega.require("Omega.Utils.Template"),a=e.prototype;Omega.Views.SaveMenuView=e.extend({template:new t("#saveMenuTemplate"),events:{"click .save_menu_expand":"onExpandClick","click .menu_save_button":"onSaveClick","click .menu_load_button":"onLoadClick","click .menu_quit_button":"onQuitClick"},initialize:function(e){a.initialize.apply(this,e)},render:function(e){var t=this.template.build();this.$el.html(t)},onExpandClick:function(){$(".save_menu_expand").toggleClass("menu_expanded");$(".save_quit_menu").toggle()},onSaveClick:function(){this.trigger("saveAs")},onLoadClick:function(){this.trigger("load")},onQuitClick:function(){this.trigger("quit")}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.Views.View"),t=Omega.require("Omega.Utils.Template"),a=e.prototype;Omega.Views.SavedGamesView=e.extend({template:new t("#savedGamesTemplate"),events:{"click .savedGameBox":"onGameClick","click .backButton":"onBack","click .deleteButton":"onDelete","click .newGameButton":"onNew","click .loadButton":"onLoad"},initialize:function(e){a.initialize.apply(this,e);this.collection=e.collection;this.gameTemplate=new t("#savedGameBoxTemplate");this.detailTemplate=new t("#savedGameDetailsTemplate");this.selected=this.collection.pluck("id").pop();this.listenTo(this.collection,"remove",this.render)},render:function(e){var t={},a,i;a=this.collection.toJSON();i=_.map(a,this.gameTemplate.build,this.gameTemplate);var s=this.collection.length-1,n=this.selectedIndex?Math.max(0,Math.max(this.selectedIndex,s)):0;this.selected=n>=0?this.collection.at(n):null;t.noSavedGames=a.length?"":"noSavedGames";t.lastSavedGameHtml=i.pop();t.allSavedGamesHtml=i.join("");var o=this.template.build(t);this.$el.html(o);this.$(".savedGameHeader .savedGameBox").addClass("active");if(this.selected)this.renderDetails()},onGameClick:function(e){var t=$(e.currentTarget),a=t.attr("data-id");if(this.selected!=a){this.selected=a;this.renderDetails()}this.$(".savedGameBox").removeClass("active");t.addClass("active")},renderDetails:function(){var e=this.collection.get(this.selected),t=e.toJSON(),a;t.created=new Date(t.created).toLocaleDateString().split("/").join(".");t.lastBattle=new Date(t.lastBattle).toLocaleDateString().split("/").join(".");a=this.detailTemplate.build(t);this.$(".gameStatistics").html(a)},onBack:function(){this.trigger("back")},onDelete:function(){this.selectedIndex=this.collection.indexOf(this.selected);this.trigger("delete",this.selected)},onNew:function(){this.trigger("new")},onLoad:function(){this.trigger("load",this.selected)}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.environment"),t=Omega.require("Omega.Views.View"),a=Omega.require("Omega.Views.StarmapZoomView"),i=Omega.require("Omega.Utils.Template"),s=t.prototype;Omega.Views.StarmapView=t.extend({initialize:function(t){s.initialize.apply(this,t);this.model=t.model;this.listenTo(this.model,"change:moveMode",this.updateGraph);this.listenTo(this.model,"selectSystem",this.highlightSystem);this.listenTo(this.model,"moveCommander",this.update);this.zoom=t.zoom||2;this.zoomView=new a({zoom:this.zoom,wheelEl:".starmapCanvas"});this.zoomView.on("changeZoom",this.changeZoom,this);this.imageLoaded=false;
this.imageSprite=new Image;this.imageSprite.src=e.imagePath+"systemIcons.png";this.imageSprite.onload=$.proxy(this.handleImageLoad,this);this.addWindowEvent("resize",_.debounce(this.render,200))},highlightSystem:function(e){var t=this.model.get("systems").get(e);this.highlightId=e;this.highlight[this.highlightIndex].visible=false;if(t){var a=t.get("faction"),i=this.highlight[a+1],s=this.getCanvasPosition(t.get("position"));this.highlightIndex=a+1;i.visible=true;i.x=s[0];i.y=s[1]}this.updateFlag=true},changeZoom:function(e,t,a){var i=t||this.width/2,s=a||this.height/2,n=(i-this.container.x-this.dx)/this.size(),o=(s-this.container.y-this.dy)/this.size();this.zoom=e;this.container.x=i-this.dx-n*this.size();this.container.y=s-this.dy-o*this.size();this.update()},update:function(){this.drawGraph();this.positionSystems();this.highlightSystem(this.highlightId);this.updateFlag=true},handleImageLoad:function(){this.imageLoaded=true;if(this.renderOnLoad)this.render()},render:function(){if(this.imageLoaded){this.cleanup();this.renderHtml();this.computeDimensions();this.setupCanvas();this.renderBackground();this.createBitmaps();this.drawGraph();this.positionSystems();this.updateFlag=true}else{this.renderOnLoad=true}},cleanup:function(){if(this.stage){this.stage.removeAllEventListeners();this.stage.removeAllChildren();this.stage=null}},renderHtml:function(){this.$el.html('<canvas class="starmapCanvas"></canvas><div class="starmapZoom"></div>');this.renderSubview(this.zoomView,this.$(".starmapZoom"))},setupCanvas:function(){this.canvas=this.$("canvas").get(0);this.canvas.width=this.width;this.canvas.height=this.height;this.stage=new createjs.Stage(this.canvas);this.stage.enableMouseOver(10);this.stage.mouseMoveOutside=true;this.background=new createjs.Shape;this.stage.addChild(this.background);this.container=new createjs.Container;this.graph=new createjs.Shape;this.container.addChild(this.graph);this.stage.addChild(this.container);createjs.Ticker.on("tick",this.updateStage,this)},updateStage:function(e){if(this.updateFlag&&this.stage){this.updateFlag=false;this.stage.update(e)}},computeDimensions:function(){this.width=window.innerWidth;this.height=window.innerHeight;this.dx=(this.width-this.size())/2;this.dy=(this.height-this.size())/2},renderBackground:function(){var e=new createjs.Shape;e.graphics.beginFill("#000").drawRect(0,0,this.width,this.height);this.background.hitArea=e;this.background.on("mousedown",this.startDrag,this);this.background.on("pressmove",this.doDrag,this);this.background.on("click",this.clickSystem,this)},startDrag:function(e){this.offset=new createjs.Point;this.offset.x=e.stageX-this.container.x;this.offset.y=e.stageY-this.container.y},doDrag:function(e){this.dragging=true;this.container.x=e.stageX-this.offset.x;this.container.y=e.stageY-this.offset.y;this.updateFlag=true},updateGraph:function(){if(this.graph){this.drawGraph();this.updateFlag=true}},drawGraph:function(){var e,t,a,i=this.graph.graphics,s=this.model.get("edges"),n=this.model.getValidMoveEdges();i.clear();if(n.length){[2,1.7,1.4].forEach(function(s){i.beginStroke("rgba(255,255,255,0.2)").setStrokeStyle(s);for(e=0;e<n.length;e++){t=this.getCanvasPosition(n[e][0]);a=this.getCanvasPosition(n[e][1]);i.moveTo(t[0],t[1]);i.lineTo(a[0],a[1])}},this)}i.beginStroke("rgba(79,186,166,0.35)").setStrokeStyle(1);for(e=0;e<s.length;e++){t=this.getCanvasPosition(s[e][0]);a=this.getCanvasPosition(s[e][1]);i.moveTo(t[0],t[1]);i.lineTo(a[0],a[1])}},createBitmaps:function(){this.highlightIndex=0;this.highlight=_.range(5).map(this.createHighlight,this);this.model.get("systems").each(this.createSystem,this)},createHighlight:function(e){var t=new createjs.Bitmap(this.imageSprite);t.visible=false;this.container.addChild(t);t.alpha=.4;t.regX=t.regY=20;t.sourceRect=new createjs.Rectangle(0,e*40,40,40);t.cursor="pointer";return t},createSystem:function(e){var t,a;t=new createjs.Bitmap(this.imageSprite);this.container.addChild(t);t.regX=t.regY=16;t.name=e.id;t.cursor="pointer";t.on("mousedown",this.clickSystem,this);t.on("rollover",this.animateSystem,this);t.on("rollout",this.stopAnimateSystem,this)},positionSystems:function(){this.model.get("systems").each(function(e){var t=this.container.getChildByName(e.id),a=this.getCanvasPosition(e.get("position")),i=e.get("faction")+(e.get("isCommander")?6:1),s=e.get("isCommander")&&e.get("faction")==this.model.get("playerFaction");t.x=a[0];t.y=a[1];t.isPlayerCommander=s;t.scaleX=s?1.2:1,t.scaleY=s?1.2:1,t.sourceRect=new createjs.Rectangle(i<5?72:40,i%5*32,32,32)},this)},clickSystem:function(e){var t=e.currentTarget;if(this.dragging){this.dragging=false}else{this.trigger("selectSystem",t.name)}},animateSystem:function(e){e.currentTarget.scaleX=e.currentTarget.scaleY=e.currentTarget.isPlayerCommander?1.4:1.2;this.updateFlag=true},stopAnimateSystem:function(e){e.currentTarget.scaleX=e.currentTarget.scaleY=e.currentTarget.isPlayerCommander?1.2:1;this.updateFlag=true},getCanvasPosition:function(e){return[this.dx+e[0]*this.size(),this.dy+e[1]*this.size()]},size:function(){return 512*Math.pow(1.5,this.zoom)}})});Omega.define(function(){"use strict";var e=Omega.require("Omega.environment"),t=Omega.require("Omega.Views.View"),a=Omega.require("Omega.Utils.Template"),i=t.prototype;Omega.Views.StarmapZoomView=t.extend({template:new a("#starmapZoomTemplate"),events:{"click .button":"buttonZoom"},initialize:function(e){i.initialize.apply(this,e);this.zoom=e.zoom||0;this.min=e.min||0;this.max=e.max||8;this.wheelEl=e.wheelEl},render:function(){this.$el.html(this.template.build());this.$(".slider").slider({orientation:"vertical",range:"min",value:this.zoom,min:this.min,max:this.max,slide:$.proxy(this.sliderZoom,this)});if(this.wheelEl)$(this.wheelEl).on("mousewheel",$.proxy(this.wheelZoom,this))},sliderZoom:function(e,t){var a=t.value-this.zoom;this.changeZoom(a)},buttonZoom:function(e){this.changeZoom($(e.target).attr("data-delta"))},wheelZoom:function(e){var t=e.deltaY<0?-1:1;this.changeZoom(t,e.clientX,e.clientY)},changeZoom:function(e,t,a){e=parseInt(e,10);this.zoom=Math.min(this.max,Math.max(this.min,this.zoom+e));if(e<0||e>0){this.$(".slider").slider("value",this.zoom);this.trigger("changeZoom",this.zoom,t,a)}}})});Omega.define(function(){"use strict";var e=Backbone.View,t=e.prototype;Omega.Views.View=e.extend({initialize:function(e){this.eventNamespace=_.uniqueId(".View")},renderSubview:function(e,t){e.setElement(this.$(t)).render()},addWindowEvent:function(e,t){$(window).on(e+this.eventNamespace,$.proxy(t,this))},remove:function(){$(window).off(this.eventNamespace);this.stopListening();t.remove.call(this)}})});